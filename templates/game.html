{% extends "layout.html" %}

{% block title %}
    Game
{% endblock %}

{% block main %}

    <game id="game" game_id="{{ game['game_id'] }}" player_ids="{{ game['player_ids'] }}" player_credits="{{ game['player_credits'] }}" player_bets="{{ game['player_bets'] }}" hand_pot="{{ game['hand_pot'] }}" sabacc_pot="{{ game['sabacc_pot'] }}" phase="{{ game['phase'] }}" deck="{{ game['deck'] }}" player_hands="{{ game['player_hands'] }}" player_protecteds="{{ game['player_protecteds'] }}" player_turn="{{ game['player_turn'] }}" completed="{{ game['completed'] }}"></game>
    <users id="users" u="{{ users }}"></users>

    <h1 id="psHeader"></h1>
    <h2 id="phase"></h2>

    <div id="tableCont">
        <div id="table"></div>
        <h2 id="pAction">{{ game["p_act"] }}</h2>
        <div id="gameInfo" class="parent">

            <div id="pots" class="child">
                <h5>Sabacc: <span id="sabacc_pot">{{ game["sabacc_pot"] }}</span></h5>
                <h5>Hand: <span id="hand_pot">{{ game["hand_pot"] }}</span></h5>
            </div>
    
            <div id="deck" class="card child">
            </div>
    
            <div id="discard" class="card child">
                <button type="button" id="tradeBtn" class="btn btn-primary smol">Trade</button>
                <br>
                <button type="button" id="standBtn" class="btn btn-primary smol">Stand</button>
            </div>
    
            <div id="dieOne" class="child die"></div>
    
            <div id="dieTwo" class="child die"></div>
    
            <div id="alderaan" class="child alderaan"></div>
    
        </div>
        {% for i in range(users|length) %}

            <div id="{{ users[i] }}Stuff" class="parent player{{ i }}"></div>

        {% endfor %}

        <div id="actBox"></div>
    </div>



    <!--Put script tags at end to load page faster-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>

        $(document).ready(function() {

            $("main").addClass("game");

            // Setup Stuff

            // Define show/hide functions
            function show(id) {
                document.getElementById(id).hidden = false;
            }

            function hide(id) {
                document.getElementById(id).hidden = true;
            }

            // User stuff
            let player_ids = $("#game").attr("player_ids").split(",");
            let u_dex = player_ids.indexOf(String({{ user_id }}));
            let us_raw = $("#users").attr("u");
            let us_part = us_raw.slice(1, us_raw.length - 1);
            let us_list = us_part.split(", ");
            let game_id = {{ game['game_id'] }};
            let thisUName = us_list[u_dex].slice(1, us_list[u_dex].length - 1);

            // Hand stuff
            let hands = "{{ game['player_hands'] }}".split(";");

            // Credits stuff
            let credits = "{{ game['player_credits'] }}".split(",");
            let pBets = "{{ game['player_bets'] }}".split(",");

            // Protected cards stuff
            let protAll = "{{ game['player_protecteds'] }}".split(";");

            // Card images
            // Players header text
            let psHeader = "";
            for (let u = 0; u < us_list.length; u++) {

                uName = us_list[u].slice(1, us_list[u].length - 1)
                psHeader += uName + " vs. ";

                if ({{ game["completed"] }} === 0) {

                    for (let i = 0; i < hands[u].split(",").length; i++) {
                        let c = hands[u].split(",")[i];
                        if (protAll[u].split(",")[i] === "0") {
                            if (u === u_dex) {
                                $("#" + uName + "Stuff").append('<div class="card child own"><h5>' + c + '</h5></div>');
                            }
                            else {
                                $("#" + uName + "Stuff").append('<div class="card child"></div>');
                            }
                        }
                        else {
                            if (u === u_dex) {
                                $("#" + uName + "Stuff").append('<div class="card child own protected"><h5>' + c + '</h5></div>');
                            }
                            else {
                                $("#" + uName + "Stuff").append('<div class="card child protected"><h5>' + c + '</h5></div>');
                            }
                        }
                    }
                }
                else if ({{ game["completed"] }} === 1) {
                    for (let i = 0; i < hands[u].split(",").length; i++) {
                        let c = hands[u].split(",")[i];
                        $("#" + uName + "Stuff").append('<div class="card child"><h5>' + c + '</h5></div>');
                    }
                }
            }
            psHeader = psHeader.slice(0, psHeader.length - 5);
            $("#psHeader").text(psHeader);

            // Bet Boxes
            for (let u = 0; u < us_list.length; u++) {

                uName = us_list[u].slice(1, us_list[u].length - 1)

                if (u === u_dex) {
                    $("#" + uName + "Stuff").prepend('<div id="' + uName + 'BetBox" class="backBlue"><h5>$' + pBets[u] + '</h5></div>');
                }
                else {
                    $("#" + uName + "Stuff").prepend('<div id="' + uName + 'BetBox" class="backRed"><h5>$' + pBets[u] + '</h5</div>');
                }
                
            }

            // Generate player boxes
            for (let i = 0; i < player_ids.length; i++) {

                uName = us_list[i].slice(1, us_list[i].length - 1)

                if (i === u_dex) {
                    $("#" + uName + "Stuff").append('<div id="' + uName + 'Box" class="backBlue"><h5>' + uName + '</h5><h5>$<span id="credits">' + credits[i] + '</span></h5>');
                }
                else {
                    $("#" + uName + "Stuff").append('<div id="' + uName + 'Box" class="backRed"> <h5>' + uName + '</h5> <h5>$<span id="' + uName + '_credits">' + credits[i] + '</span></h5>');
                }
            }

            // Phase text
            $("#phase").text($("#game").attr("phase") + " phase");

            // General Socket Setup

            let dom = "http://127.0.0.1:5000";

            var socket = io.connect(dom);
            var game_socket = io(dom + '/game');
            var protect_socket = io(dom + '/protect');
            var bet_socket = io(dom + '/bet');
            var card_socket = io(dom + '/card');
            var cont_socket = io(dom + '/cont');

            game_socket.on('connect', function() {
                game_socket.emit("game");
            });


            // When server sends a command
            protect_socket.on('message', function(msg) {

                // Check to see if the broadcast is referring to this game
                if (msg["g_id"] === game_id) {

                    // Server told client to force reload
                    if (msg["cmd"] === "reload") {
                        location.reload();
                    }
                }

            });

            bet_socket.on('message', function(msg) {

                // Check to see if the broadcast is referring to this game
                if (msg["g_id"] === game_id) {

                    // Server told client to force reload
                    if (msg["cmd"] === "reload") {
                        location.reload();
                    }
                }

            });

            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            card_socket.on('message', function(msg) {

                // Check to see if the broadcast is referring to this game
                if (msg["g_id"] === game_id) {

                    // Server told client to force reload
                    if (msg["cmd"] === "reload") {
                        location.reload();
                    }

                }


            });

            cont_socket.on('message', function(msg) {

                // Check to see if the broadcast is referring to this game
                if (msg["g_id"] === game_id) {

                    // Server told client to force reload
                    if (msg["cmd"] === "reload") {
                        location.reload();
                    }

                }


            });


            if ({{ game["shift"] }} === 1) {
                $("#dieTwo").css("background-color", "#0cc23c");
            }


            // Protecting stuff

            $('.own').mousedown(function(event) {
                    switch (event.which) {

                        case 1:
                            break;

                        case 2:
                            break;

                        case 3:
                            $(this).addClass("protected");
                            data = {"game_id": game_id, "protect": $(this).text()}; // There is a bug here. One day I will regret this. Do not protect two identical cards.
                            protect_socket.emit("protect", data);
                            break;

                        default:
                            
                    }
                });

            
            // Alderaan blown up
            if ("{{ game['phase'] }}" === "alderaan") {
                $("#alderaan").addClass("blown");
            }


            // If it is the player's turn
            if ({{ game["player_turn"] }} === {{ user_id }}) {
                
                // Betting Phase
                if ('{{ game["phase"] }}' === "betting") {
                    if (u_dex === 0) {

                        // If there has been no raise
                        if (pBets[u_dex + 1] === "") {

                            $("#pots").addClass("active");

                            // Double Tap Check
                            $("#pots").dblclick(function(){
                                data = { "game_id": game_id, "action": "bet", "amount": 0};
                                bet_socket.emit("bet", data);
                            });

                            $("#actBox").append('<div id="betDiv" class="backBlue"> <form> <input id="betCredits" type="number" class="form-control form-group" min="0" max="' + credits[u_dex] + '" placeholder="Credits" required> <button type="button" id="betBtn" class="btn btn-primary">Bet</button> </form><p id="invalidBetCredits" class="red"></p></div>');

                            $("#betBtn").click(function(){
                                let credsIn = document.getElementById("betCredits").value;
                                if (credsIn === "") {
                                    document.getElementById("invalidBetCredits").innerHTML =
                                    "Please input a number of credits you would like to bet(an integer 0 to " + credits[u_dex] +
                                ")";
                                } else if (isNaN(parseInt(credsIn))) {
                                    document.getElementById("invalidBetCredits").innerHTML =
                                "Invalid amount of credits - Please input a valid number of credits (an integer 0 to " +
                                credits[u_dex] + ")";
                                } else if (credsIn < 0 || credsIn > parseInt(credits[u_dex])) {
                                    document.getElementById("invalidBetCredits").innerHTML =
                                "Invalid amount of credits - Please input a valid number of credits (an integer 0 to " +
                                credits[u_dex] + ")";
                                } else {
                                    hide("betDiv");
                                    data = { "game_id": game_id, "action": "bet", "amount": parseInt(credsIn) };
                                    bet_socket.emit("bet", data);
                                }
                            });

                        }

                        // If there has been a raise
                        else {
                            let raiseAmount = 0;
                            let followAmount = 0;
                            for (let i = 1; i < pBets.length; i++) {
                                if (pBets[i] != "") {
                                    if (parseInt(pBets[i]) > raiseAmount) {
                                        raiseAmount = parseInt(pBets[i]);
                                    }
                                }
                            }
                            followAmount = raiseAmount - parseInt(pBets[u_dex]);


                            $("#actBox").append('<div id="betDiv" class="backBlue"> <form> <button type="button" id="callOpt" class="btn btn-primary">Call</button> <button type="button" id="raiseOpt" class="btn btn-primary">Raise</button> <button type="button" id="foldOpt" class="btn btn-primary">Fold</button> </form><p id="invalidBetCredits" class="red"></p></div>');

                            // Player calls
                            $("#callOpt").click(function(){
                                hide("betDiv");
                                data = { "game_id": game_id, "action": "call", "amount": followAmount};
                                bet_socket.emit("bet", data);
                            });


                            // Player raises
                            $("#raiseOpt").click(function(){

                                // Remove old form prompt
                                $("#betDiv").remove();


                                // Ask how much to raise to
                                $("#" + thisUName + "Stuff").append('<div id="betDiv" class="backBlue"> <form> <input id="betCredits" type="number" class="form-control form-group" min="0" max="' + credits[u_dex] + '" placeholder="Credits" required> <button type="button" id="betBtn" class="btn btn-primary">Raise</button> </form><p id="invalidBetCredits" class="red"></p></div>');

                                $("#betBtn").click(function(){
                                    let credsIn = document.getElementById("betCredits").value;
                                    if (credsIn === "") {
                                        document.getElementById("invalidBetCredits").innerHTML =
                                        "Please input a number of credits you would like to bet(an integer " + String(parseInt(pBets[0]) + 1) + " to " + credits[u_dex] +
                                    ")";
                                    } 
                                    else if (isNaN(parseInt(credsIn))) {
                                        document.getElementById("invalidBetCredits").innerHTML =
                                    "Invalid amount of credits - Please input a valid number of credits (an integer " + String(parseInt(pBets[0]) + 1) + " to " +
                                    credits[u_dex] + ")";
                                    } 
                                    else if (credsIn <= parseInt(pBets[0]) || credsIn > parseInt(credits[u_dex])) {
                                        document.getElementById("invalidBetCredits").innerHTML =
                                    "Invalid amount of credits - Please input a valid number of credits (an integer " + String(parseInt(pBets[0]) + 1) + " to " +
                                    credits[u_dex] + ")";
                                    } 
                                    else {
                                        hide("betDiv");
                                        data = { "game_id": game_id, "action": "raise", "amount": parseInt(credsIn) - pBets[u_dex] };
                                        bet_socket.emit("bet", data);
                                    }
                                });

                            });

                            // Player folds
                            $("#foldOpt").click(function(){
                                hide("betDiv");
                                data = { "game_id": game_id, "action": "fold"};
                                bet_socket.emit("bet", data);
                            });
                            
                        }


                    }

                    else {

                        $("#actBox").append('<div id="betDiv" class="backBlue"> <form> <button type="button" id="callOpt" class="btn btn-primary">Call</button> <button type="button" id="raiseOpt" class="btn btn-primary">Raise</button> <button type="button" id="foldOpt" class="btn btn-primary">Fold</button> </form><p id="invalidBetCredits" class="red"></p></div>');

                        // Player calls
                        $("#callOpt").click(function(){
                            hide("betDiv");
                            let a;
                            if (pBets[u_dex] != "") {
                                a = parseInt(pBets[0]) - parseInt(pBets[u_dex]);
                            } 
                            else {
                                a = parseInt(pBets[0]);
                            }


                            data = { "game_id": game_id, "action": "call", "amount": a};
                            bet_socket.emit("bet", data);
                        });


                        // Player raises
                        $("#raiseOpt").click(function(){

                            // Remove old form prompt
                            $("#betDiv").remove();


                            // Ask how much to raise to
                            $("#actBox").append('<div id="betDiv" class="backBlue"> <form> <input id="betCredits" type="number" class="form-control form-group" min="0" max="' + credits[u_dex] + '" placeholder="Credits" required> <button type="button" id="betBtn" class="btn btn-primary">Raise</button> </form><p id="invalidBetCredits" class="red"></p></div>');

                            $("#betBtn").click(function(){
                                let credsIn = document.getElementById("betCredits").value;
                                if (credsIn === "") {
                                    document.getElementById("invalidBetCredits").innerHTML =
                                    "Please input a number of credits you would like to bet(an integer " + String(parseInt(pBets[0]) + 1) + " to " + credits[u_dex] +
                                ")";
                                } else if (isNaN(parseInt(credsIn))) {
                                    document.getElementById("invalidBetCredits").innerHTML =
                                "Invalid amount of credits - Please input a valid number of credits (an integer " + String(parseInt(pBets[0]) + 1) + " to " +
                                credits[u_dex] + ")";
                                } else if (credsIn <= parseInt(pBets[0]) || credsIn > parseInt(credits[u_dex])) {
                                    document.getElementById("invalidBetCredits").innerHTML =
                                "Invalid amount of credits - Please input a valid number of credits (an integer " + String(parseInt(pBets[0]) + 1) + " to " +
                                credits[u_dex] + ")";
                                } else {
                                    hide("betDiv");
                                    let a;

                                    if (pBets[u_dex] != "") {
                                        a = parseInt(credsIn) - parseInt(pBets[u_dex]);
                                    } 
                                    else {
                                        a = parseInt(credsIn);
                                    }

                                    data = { "game_id": game_id, "action": "raise", "amount": a };
                                    bet_socket.emit("bet", data);
                                }
                            });
                        });

                        // Player folds
                        $("#foldOpt").click(function(){
                            hide("betDiv");
                            data = { "game_id": game_id, "action": "fold"};
                            bet_socket.emit("bet", data);
                        });

                    }

                }


                else if ("{{ game['phase'] }}" === "card" || "{{ game['phase'] }}" === "alderaan") {

                    if ("{{ game['phase'] }}" === "card" && {{ game["cycle_count"] }} != 0) {

                        $("#alderaan").addClass("active");

                        $("#alderaan").click(function(){
                           
                            data = { "game_id": game_id, "action": "alderaan"};
                            card_socket.emit("card", data);
                            
                        });
                    }

                    $("#deck").addClass("active");
                    $("#discard").addClass("active");

                    $("#deck").click(function(){
                        data = { "game_id": game_id, "action": "draw"};
                        card_socket.emit("card", data);
                    });

                    $("#tradeBtn").click(function(){
                        $('.own').click(function(event) {
                            switch (event.which) {

                                case 1:
                                    data = { "game_id": game_id, "action": "trade", "trade": $(this).find("h5").text()};
                                    card_socket.emit("card", data);
                                    break;

                                case 2:
                                    break;

                                case 3:
                                    break;

                                default:
                                    
                            }
                        });

                        
                    });

                    $("#standBtn").click(function(){
                        data = { "game_id": game_id, "action": "stand"};
                        card_socket.emit("card", data);
                    });

                }

                if ({{ game["completed"] }} === 1) {
                    $("#gameInfo").append('<button type="button" id="pAgainBtn" class="btn btn-primary">Play Again</button>');

                    $("#pAgainBtn").click(function(){
                        

                        data = { "game_id": game_id };
                        cont_socket.emit("cont", data);
                        
                    });
                }

            }


        });

    </script>

{% endblock %}